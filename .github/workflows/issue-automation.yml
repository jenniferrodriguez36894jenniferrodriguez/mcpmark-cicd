name: Issue Management Automation

on:
  issues:
    types: [opened, labeled]

jobs:
  issue-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure required labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              {name: 'bug', color: 'd73a4a', description: "Something isn't working"},
              {name: 'enhancement', color: 'a2eeef', description: 'New feature or request'},
              {name: 'epic', color: '5319e7', description: 'Large feature requiring multiple sub-tasks'},
              {name: 'maintenance', color: 'f9d0c4', description: 'Maintenance and housekeeping tasks'},
              {name: 'priority-critical', color: 'b60205', description: 'Critical priority issue'},
              {name: 'priority-high', color: 'd93f0b', description: 'High priority issue'},
              {name: 'priority-medium', color: 'fbca04', description: 'Medium priority issue'},
              {name: 'priority-low', color: '0e8a16', description: 'Low priority issue'},
              {name: 'needs-triage', color: 'e4e669', description: 'Needs to be reviewed by maintainers'},
              {name: 'needs-review', color: '0052cc', description: 'Awaiting review from maintainers'},
              {name: 'first-time-contributor', color: '5319e7', description: 'Issue created by first-time contributor'}
            ];
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
              } catch (e) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
              }
            }
      - name: Add needs-triage label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-triage']
            });
      - name: Auto-assign category labels
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            let category = null;
            if (title.includes('bug')) category = 'bug';
            else if (title.includes('epic')) category = 'epic';
            else if (title.includes('maintenance')) category = 'maintenance';
            if (category) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [category]
              });
            }
      - name: Auto-assign priority labels
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            let priority = 'priority-medium';
            if (/(critical|urgent|production|outage)/.test(title) || /(critical|urgent|production|outage)/.test(body)) {
              priority = 'priority-critical';
            } else if (/(important|high|blocking)/.test(title) || /(important|high|blocking)/.test(body)) {
              priority = 'priority-high';
            } else if (/(low|nice-to-have|minor)/.test(title) || /(low|nice-to-have|minor)/.test(body)) {
              priority = 'priority-low';
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [priority]
            });

  task-breakdown:
    needs: issue-triage
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'Epic') || contains(github.event.issue.title, 'epic')
    steps:
      - name: Create sub-issues for Epic
        id: create_subtasks
        uses: actions/github-script@v7
        with:
          script: |
            const parentNumber = context.issue.number;
            const parentTitle = context.payload.issue.title;
            const subTasks = [
              'Requirements Analysis',
              'Design and Architecture',
              'Implementation',
              'Testing and Documentation'
            ];
            const subIssueNumbers = [];
            for (let i = 0; i < subTasks.length; i++) {
              const subTitle = `[SUBTASK] ${parentTitle} - Task ${i+1}: ${subTasks[i]}`;
              const subBody = `Related to #${parentNumber}\n\nTask: ${subTasks[i]}`;
              const subIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: subTitle,
                body: subBody,
                labels: ['enhancement', 'needs-review']
              });
              subIssueNumbers.push(subIssue.data.number);
            }
            return subIssueNumbers;
      - name: Update parent Epic with checklist
        uses: actions/github-script@v7
        with:
          script: |
            const parentNumber = context.issue.number;
            const subIssueNumbers = ${{ steps.create_subtasks.outputs.result }};
            let checklist = '## Epic Tasks\n';
            for (const num of JSON.parse(subIssueNumbers)) {
              checklist += `- [ ] #${num}\n`;
            }
            const oldBody = context.payload.issue.body || '';
            const newBody = `${oldBody}\n\n${checklist}`;
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentNumber,
              body: newBody
            });

  auto-response:
    needs: issue-triage
    runs-on: ubuntu-latest
    steps:
      - name: Check if first-time contributor
        id: first_time
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: context.payload.issue.user.login,
              state: 'all'
            });
            const isFirst = issues.filter(i => i.number !== context.issue.number).length === 0;
            if (isFirst) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['first-time-contributor']
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ðŸŽ‰ Welcome! Thank you for your first issue in this repository.'
              });
            }
            return isFirst;
      - name: Post type-specific response
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            let comment = '';
            if (labels.includes('bug')) {
              comment = 'Thank you for reporting a bug! Please review our **Bug Report Guidelines**.';
            } else if (labels.includes('epic')) {
              comment = 'Thank you for your feature request! Please review our **Feature Request Process**.';
            } else if (labels.includes('maintenance')) {
              comment = 'Thank you for your maintenance report! Please review our **Maintenance Guidelines**.';
            }
            if (comment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      - name: Set milestone for high/critical priority
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            if (labels.includes('priority-high') || labels.includes('priority-critical')) {
              const milestones = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              let milestone = milestones.data.find(m => m.title === 'v1.0.0');
              if (!milestone) {
                milestone = await github.rest.issues.createMilestone({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'v1.0.0'
                });
                milestone = milestone.data;
              }
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                milestone: milestone.number
              });
            }
      - name: Change status from needs-triage to needs-review
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            if (labels.includes('needs-triage')) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'needs-triage'
              });
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-review']
            });
